var gdjs;(function(u){const r=new u.Logger("Player Authentication"),g=u.playerAuthenticationComponents;let X;(function(s){let b=null,T=null,v=null,S=!1,y=!1,W=null,A=null,E=null,D=null,h=null,d=null,P=null,x=null,R=null,f=null,m=null;const Y=e=>{N(e)==="games-platform"&&(r.info("Notifying parent window that player authentication is ready."),window.parent.postMessage({id:"playerAuthReady"},"*"),P=setTimeout(()=>{r.info("Removing automatic games platform authentication listener."),U()},3e3))},Z=e=>{N(e)==="games-platform"&&(U(),R=t=>{L({runtimeScene:e,event:t,checkOrigin:!0})},window.addEventListener("message",R,!0))},ee=e=>{const t=e.getGame().getAdditionalOptions();if(t&&t.isPreview){const n=t.playerId,i=t.playerToken,o=t.playerUsername;n&&i&&(r.info(`Automatically logging in the player with ID ${n} as it's a preview.`),F({userId:n,username:o||null,userToken:i}),q(e))}};u.registerRuntimeScenePostEventsCallback(()=>{S=!1}),u.registerFirstRuntimeSceneLoadedCallback(e=>{ee(e),Z(e),Y(e)});const _=e=>`${e}_authenticatedUser`,j=({runtimeGame:e,gameId:t,connectionId:n,authWindowOptions:i})=>{const o="https://gd.games",a=new URLSearchParams;if(a.set("gameId",t),n&&a.set("connectionId",n),e.isUsingGDevelopDevelopmentEnvironment()&&a.set("dev","true"),a.set("allowLoginProviders","true"),i)for(const[c,l]of Object.entries(i))a.set(c,l.toString());return`${o}/auth?${a.toString()}`},N=e=>e.getGame().getRenderer().getElectron()?"electron":te(e)?"web-iframe":typeof cordova!="undefined"?"cordova-websocket":window.parent!==window&&(document.referrer.indexOf("https://gd.games")===0||document.referrer.indexOf("http://localhost:4000")===0)?"games-platform":"web",te=e=>{const t=e.getGame().getAdditionalOptions();return t&&t.isPreview&&t.allowAuthenticationUsingIframeForPreview};s.isAuthenticated=()=>(y||I(),v!==null),s.hasLoggedIn=()=>S,s.getUsername=()=>(y||I(),b||""),s.getUserToken=()=>(y||I(),v||null),s.getUserId=()=>(y||I(),T||"");const H=(e,t,n=0)=>{const o=`${e.isUsingGDevelopDevelopmentEnvironment()?"https://api-dev.gdevelop.io":"https://api.gdevelop.io"}/game/public-game/${t}`;return fetch(o,{method:"HEAD"}).then(a=>a.status!==200?(r.warn(`Error while fetching the game: ${a.status} ${a.statusText}`),a.status===404||n>2?!1:H(e,t,n+1)):!0,a=>(r.error("Error while fetching game:",a),!1))};s.logout=e=>{b=null,v=null,T=null;const t=u.projectData.properties.projectUuid;if(!t){r.error("Missing game id in project properties.");return}window.localStorage.removeItem(_(t)),G(e),s.removeAuthenticationBanner(e);const n=e.getGame().getRenderer().getDomElementContainer();if(!n){w(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}g.displayLoggedOutNotification(n)};const I=()=>{const e=u.projectData.properties.projectUuid;if(!e){r.error("Missing game id in project properties.");return}try{const t=window.localStorage.getItem(_(e));if(!t){y=!0;return}const n=JSON.parse(t);b=n.username,T=n.userId,v=n.userToken,y=!0}catch(t){r.warn("Unable to read authentication details from localStorage. Player authentication will not be available.",t)}},G=e=>{if(s.removeAuthenticationContainer(e),V(),m&&(r.info("Closing authentication websocket connection."),m.close(),m=null),W&&(W.close(),W=null),typeof SafariViewController!="undefined")try{SafariViewController.hide()}catch{r.info("Could not hide login window. Waiting for user to do it.")}},F=({username:e,userId:t,userToken:n})=>{e||r.warn("The authenticated player does not have a username"),b=e,T=t,v=n,S=!0;const i=u.projectData.properties.projectUuid;if(!i){r.error("Missing game id in project properties.");return}try{window.localStorage.setItem(_(i),JSON.stringify({username:b,userId:T,userToken:v}))}catch(o){r.warn("Unable to save the authentication details to localStorage. Player authentication will not be available.",o)}};s.login=({runtimeScene:e,userId:t,username:n,userToken:i})=>{F({userId:t,username:n,userToken:i}),G(e),s.removeAuthenticationBanner(e);const o=e.getGame().getRenderer().getDomElementContainer();if(!o){w(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}g.displayLoggedInNotification(o,b||"Anonymous")};const L=function({runtimeScene:e,event:t,checkOrigin:n,onDone:i}){const o=l=>{s.login({runtimeScene:e,userId:l.data.body.userId,username:l.data.body.username,userToken:l.data.body.token}),O(e),i&&i("logged")},a=l=>{F({userId:l.data.body.userId,username:l.data.body.username,userToken:l.data.body.token}),U(),q(e),i&&i("logged")};if(!(n&&!["https://gd.games","http://localhost:4000"].includes(t.origin))){if(!t.data.id)throw new Error("Malformed message");switch(t.data.id){case"authenticationResult":{if(!(t.data.body&&t.data.body.token))throw new Error("Malformed message.");r.info("Received authentication result, logging in player."),o(t);break}case"alreadyAuthenticated":{if(!(t.data.body&&t.data.body.token))throw new Error("Malformed message.");if(r.info("Player is already authenticated, logging in player."),A){o(t);break}a(t);break}}}},w=function(e,t){r.error(t),G(e);const n=e.getGame().getRenderer().getDomElementContainer();if(!n){w(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}g.displayErrorNotification(n),O(e)},ne=e=>{V();const t=15*60*1e3;x=setTimeout(()=>{r.info("Authentication window did not send message in time. Closing it."),G(e),O(e)},t)},V=()=>{x&&clearTimeout(x)},K=function(e){const t=()=>{s.removeAuthenticationBanner(e)},n=()=>{s.openAuthenticationWindow(e)};return v?g.computeAuthenticatedBanner(n,t,b):g.computeNotAuthenticatedBanner(n,t)};s.displayAuthenticationBanner=function(e){if(d){d.style.opacity="1";return}y||I();const t=e.getGame().getRenderer().getDomElementContainer();if(!t){w(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}d=K(e),t.appendChild(d)};const q=function(e){if(!d)return;const t=e.getGame().getRenderer().getDomElementContainer();if(!t){w(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}const n=d;d=K(e),t.replaceChild(d,n)},z=(e,t,n)=>new Promise(i=>{let o=!1;const a=e.getGame().isUsingGDevelopDevelopmentEnvironment()?`wss://api-ws-dev.gdevelop.io/play?gameId=${t}&connectionType=login`:`wss://api-ws.gdevelop.io/play?gameId=${t}&connectionType=login`;m=new WebSocket(a),m.onopen=()=>{r.info("Opened authentication websocket connection."),m&&m.send(JSON.stringify({action:"getConnectionId"}))},m.onerror=()=>{r.info("Error in authentication websocket connection."),o||(o=!0,i("errored")),w(e,"Error while connecting to the authentication server.")},m.onclose=()=>{r.info("Closing authentication websocket connection."),o||(o=!0,i("dismissed"))},m.onmessage=c=>{if(c.data){const l=JSON.parse(c.data);switch(l.type){case"authenticationResult":{const p=l.data;s.login({runtimeScene:e,userId:p.userId,username:p.username,userToken:p.token}),O(e),o=!0,i("logged");break}case"connectionId":{const C=l.data.connectionId;if(!C){r.error("No WebSocket connectionId received"),o=!0,i("errored");return}r.info("WebSocket connectionId received."),n({connectionId:C,resolve:i});break}}}}}),ie=(e,t,n)=>z(e,t,({connectionId:i})=>{const o=j({runtimeGame:e.getGame(),gameId:t,connectionId:i,authWindowOptions:n}),a=e.getGame().getRenderer().getElectron(),c=()=>a.shell.openExternal(o);c(),h&&g.addAuthenticationUrlToTextsContainer(c,h)}),ae=(e,t,n)=>z(e,t,({connectionId:i,resolve:o})=>{const a=j({runtimeGame:e.getGame(),gameId:t,connectionId:i,authWindowOptions:n});SafariViewController.isAvailable(function(c){c?SafariViewController.show({url:a,hidden:!1,animated:!0,transition:"slide",enterReaderModeIfAvailable:!1,barColor:"#000000",tintColor:"#ffffff",controlTintColor:"#ffffff"},function(l){l.event==="closed"&&o("dismissed")},function(l){r.log("Error opening webview: "+JSON.stringify(l)),o("errored")}):(r.error("Plugin SafariViewController is not available"),o("errored"))})}),re=(e,t,n)=>new Promise(i=>{const o=j({runtimeGame:e.getGame(),gameId:t,authWindowOptions:n});let a=!1;f=B=>{L({runtimeScene:e,event:B,checkOrigin:!0,onDone:M=>{a||(a=!0,i(M))}})},window.addEventListener("message",f,!0);const c=screen.width/2-500/2,l=screen.height/2-600/2,p=`left=${c},top=${l},width=500,height=600`,C=()=>{W=window.open(o,"authentication",p)};C(),h&&g.addAuthenticationUrlToTextsContainer(C,h)}),se=(e,t,n)=>new Promise(i=>{if(!D||!E||!h){r.error("Can't open an authentication iframe - no iframe container, loader container or text container was opened for it.");return}const o=j({runtimeGame:e.getGame(),gameId:t,authWindowOptions:n});f=a=>{L({runtimeScene:e,event:a,checkOrigin:!0,onDone:i})},window.addEventListener("message",f,!0),g.displayIframeInsideAuthenticationContainer(D,E,h,o)});s.openAuthenticationWindowForGamesPlatform=(e,t,n)=>new Promise(i=>{U(),f=o=>{L({runtimeScene:e,event:o,checkOrigin:!0,onDone:i})},window.addEventListener("message",f,!0),window.parent.postMessage({id:"openGameAuthenticationDialog",gameId:t,disableGuestLogin:n.disableGuestLogin},"*")}),s.openAuthenticationWindow=(e,t={disableGuestLogin:!1})=>new u.PromiseTask(new Promise(n=>{const i=e.getGame().getRenderer().getDomElementContainer();if(!i){w(e,"The div element covering the game couldn't be found, the authentication window cannot be displayed."),n({status:"errored"});return}const o=u.projectData.properties.projectUuid;if(!o){w(e,"The game ID is missing, the authentication window cannot be opened."),n({status:"errored"});return}let a=!1;const c=()=>{G(e),s.displayAuthenticationBanner(e),a=!0,n({status:"dismissed"})};d&&(d.style.opacity="0");const l=N(e),{rootContainer:p,loaderContainer:C,iframeContainer:B}=g.computeAuthenticationContainer(c);A=p,E=C,D=B,i.appendChild(A),(async()=>{const M=await H(e.getGame(),o);if(E){const Q=e.getGame().getRenderer().getElectron(),ge=Q?()=>Q.shell.openExternal("https://wiki.gdevelop.io/gdevelop5/publishing/web"):null;h=g.addAuthenticationTextsToLoadingContainer(E,l,M,ge)}if(!M)return;ne(e);let k;switch(l){case"electron":k=await ie(e,o,t);break;case"cordova-websocket":k=await ae(e,o,t);break;case"web-iframe":k=await se(e,o,t);break;case"games-platform":k=await s.openAuthenticationWindowForGamesPlatform(e,o,t);break;case"web":default:k=await re(e,o,t);break}a||(k==="dismissed"&&c(),n({status:k}))})()})),s.isAuthenticationWindowOpen=function(){return!!A},s.removeAuthenticationContainer=function(e){ue();const t=e.getGame().getRenderer().getDomElementContainer();if(!t){r.info("The div element covering the game couldn't be found, the authentication must be already closed.");return}A&&t.removeChild(A),A=null,E=null,D=null,h=null};const ue=function(){f&&(window.removeEventListener("message",f,!0),f=null)},U=function(){R&&(window.removeEventListener("message",R,!0),R=null),P&&(clearTimeout(P),P=null)};s.removeAuthenticationBanner=function(e){if(!d){r.info("The authentication banner couldn't be found, the authentication banner must be already closed.");return}const t=e.getGame().getRenderer().getDomElementContainer();if(!t){r.info("The div element covering the game couldn't be found, the authentication must be already closed.");return}t.removeChild(d),d=null};const O=function(e){const t=e.getGame().getRenderer().getCanvas();t&&t.focus()}})(X=u.playerAuthentication||(u.playerAuthentication={}))})(gdjs||(gdjs={}));
//# sourceMappingURL=playerauthenticationtools.js.map
