var gdjs;(function(i){const o=new i.Logger("Leaderboards");let G;(function(j){let O;(function(c){let D=!1,k=!0;i.registerRuntimeScenePostEventsCallback(()=>{D=!1}),c.hasPlayerJustClosedLeaderboardView=()=>D;const B=t=>{const e=new jsSHA("SHA-256","TEXT",{encoding:"UTF8"});return e.update(t),e.getHash("B64")},I="https://gd.games";class R{constructor(){this.lastScoreSavingStartedAt=null;this.lastScoreSavingSucceededAt=null;this.lastSavingPromise=null;this._currentlySavingScore=null;this._currentlySavingPlayerName=null;this._currentlySavingPlayerId=null;this._lastSavedScore=null;this._lastSavedPlayerName=null;this._lastSavedPlayerId=null;this.lastSavedLeaderboardEntry=null;this.lastSaveError=null;this.hasScoreBeenSaved=!1;this.hasScoreSavingErrored=!1}isSaving(){return!!this.lastSavingPromise&&!this.hasScoreBeenSaved&&!this.hasScoreSavingErrored}_isSameAsLastScore({playerName:e,playerId:r,score:n}){return(!!e&&this._lastSavedPlayerName===e||!!r&&this._lastSavedPlayerId===r)&&this._lastSavedScore===n}_isAlreadySavingThisScore({playerName:e,playerId:r,score:n}){return this.isSaving()?(!!e&&this._currentlySavingPlayerName===e||!!r&&this._currentlySavingPlayerId===r)&&this._currentlySavingScore===n:!1}_isTooSoonToSaveAnotherScore(){return!!this.lastScoreSavingStartedAt&&Date.now()-this.lastScoreSavingStartedAt<500}startSaving({playerName:e,playerId:r,score:n}){if(this._isAlreadySavingThisScore({playerName:e,playerId:r,score:n}))throw o.warn("There is already a request to save with this player name and this score. Ignoring this one."),new Error("Ignoring this saving request.");if(this._isSameAsLastScore({playerName:e,playerId:r,score:n}))throw o.warn("The player and score to be sent are the same as previous one. Ignoring this one."),this._setError("SAME_AS_PREVIOUS"),new Error("Ignoring this saving request.");if(this._isTooSoonToSaveAnotherScore())throw o.warn("Last entry was sent too little time ago. Ignoring this one."),this._setError("TOO_FAST"),this.lastScoreSavingStartedAt=Date.now(),new Error("Ignoring this saving request.");let a;const g=new Promise(s=>{a=s});return this.lastScoreSavingStartedAt=Date.now(),this.lastSavingPromise=g,this.hasScoreBeenSaved=!1,this.hasScoreSavingErrored=!1,this._currentlySavingScore=n,e&&(this._currentlySavingPlayerName=e),r&&(this._currentlySavingPlayerId=r),{closeSaving:s=>{if(g!==this.lastSavingPromise){o.info("Score saving result received, but another save was launched in the meantime - ignoring the result of this one."),a();return}this.lastScoreSavingSucceededAt=Date.now(),this._lastSavedScore=this._currentlySavingScore,this._lastSavedPlayerName=this._currentlySavingPlayerName,this._lastSavedPlayerId=this._currentlySavingPlayerId,this.lastSavedLeaderboardEntry=s,this.hasScoreBeenSaved=!0,a()},closeSavingWithError:s=>{if(g!==this.lastSavingPromise){o.info("Score saving result received, but another save was launched in the meantime - ignoring the result of this one."),a();return}this._setError(s),a()}}}_setError(e){this.lastSaveError=e,this.hasScoreBeenSaved=!1,this.hasScoreSavingErrored=!0}}let u={},C,l=null,M=!1,E=!1,f=!1,A=null,T=null;const h=document.createElement("div");h.style.backgroundColor="#000000",h.style.display="flex",h.style.height="100%",h.style.width="100%",h.style.justifyContent="center",h.style.alignItems="center",h.style.position="relative",h.style.zIndex="2";const _=document.createElement("img");_.setAttribute("width","50px"),_.setAttribute("src","data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9Im5vbmUiIHZpZXdCb3g9IjAgMCAyNCAyNCI+CjxjaXJjbGUgb3BhY2l0eT0nMC4yNScgY3g9IjEyIiBjeT0iMTIiIHI9IjEwIiBzdHJva2U9IiNGRkZGRkYiIHN0cm9rZS13aWR0aD0iNCI+PC9jaXJjbGU+CjxwYXRoIG9wYWNpdHk9JzAuNzUnIGZpbGw9IiNGRkZGRkYiIGQ9Ik00IDEyYTggOCAwIDAxOC04VjBDNS4zNzMgMCAwIDUuMzczIDAgMTJoNHptMiA1LjI5MUE3Ljk2MiA3Ljk2MiAwIDAxNCAxMkgwYzAgMy4wNDIgMS4xMzUgNS44MjQgMyA3LjkzOGwzLTIuNjQ3eiI+PC9wYXRoPgo8L3N2Zz4=");try{_.animate([{transform:"rotate(0deg)"},{transform:"rotate(359deg)"}],{duration:3e3,iterations:1/0})}catch{o.warn("Animation not supported, loader will be fixed.")}h.appendChild(_);const P=function({hasSucceeded:t}){const e=a=>t?a.lastScoreSavingSucceededAt:a.lastScoreSavingStartedAt,r=Object.values(u).filter(a=>!!e(a));if(r.length===0)return null;let n=r[0];return r.forEach(a=>{const g=e(a),s=e(n);g&&s&&g>s&&(n=a)}),n},x=async function({leaderboardId:t,playerName:e,authenticatedPlayerData:r,score:n,runtimeScene:a}){const s=`${a.getGame().isUsingGDevelopDevelopmentEnvironment()?"https://api-dev.gdevelop.io":"https://api.gdevelop.io"}/play`,d=a.getGame(),S={score:n,sessionId:d.getSessionId(),clientPlayerId:d.getPlayerId(),location:typeof window!="undefined"&&window.location?window.location.href:""},p={"Content-Type":"application/json"};let w=`${s}/game/${i.projectData.properties.projectUuid}/leaderboard/${t}/entry`;r?(p.Authorization=`player-game-token ${r.playerToken}`,w+=`?playerId=${r.playerId}`):S.playerName=c.formatPlayerName(e);const b=JSON.stringify(S);p.Digest=B(b);try{const v=await fetch(w,{body:b,method:"POST",headers:p});if(!v.ok){const y=v.status.toString();throw o.error("Server responded with an error:",y,v.statusText),y}try{return await v.json()}catch(y){throw o.warn("An error occurred when reading response but score has been saved:",y),"SAVED_ENTRY_CANT_BE_READ"}}catch(v){throw o.error("Error while submitting a leaderboard score:",v),"REQUEST_NOT_SENT"}};c.setPreferSendConnectedPlayerScore=(t,e)=>{k=e},c.savePlayerScore=(t,e,r,n)=>k&&i.playerAuthentication.isAuthenticated()?c.saveConnectedPlayerScore(t,e,r):new i.PromiseTask((async()=>{const a=u[e]=u[e]||new R;try{const{closeSaving:g,closeSavingWithError:s}=a.startSaving({playerName:n,score:r});try{const d=await x({leaderboardId:e,playerName:n,score:r,runtimeScene:t});g(d)}catch(d){s(d)}}catch{}})()),c.saveConnectedPlayerScore=(t,e,r)=>new i.PromiseTask((async()=>{const n=i.playerAuthentication.getUserId(),a=i.playerAuthentication.getUserToken();if(!n||!a){o.warn("Cannot save a score for a connected player if the player is not connected.");return}const g=u[e]=u[e]||new R;try{const{closeSaving:s,closeSavingWithError:d}=g.startSaving({playerId:n,score:r});try{const S=await x({leaderboardId:e,authenticatedPlayerData:{playerId:n,playerToken:a},score:r,runtimeScene:t});s(S)}catch(S){d(S)}}catch{}})()),c.isSaving=function(t){if(t)return u[t]?u[t].isSaving():!1;const e=P({hasSucceeded:!1});return e?e.isSaving():!1},c.hasBeenSaved=function(t){if(t)return u[t]?u[t].hasScoreBeenSaved:!1;const e=P({hasSucceeded:!0});return e?e.hasScoreBeenSaved:!1},c.hasSavingErrored=function(t){if(t)return u[t]?u[t].hasScoreSavingErrored:!1;const e=P({hasSucceeded:!1});return e?e.hasScoreSavingErrored:!1},c.getLastSaveError=function(t){if(t)return u[t]?u[t].lastSaveError:"NO_DATA_ERROR";const e=P({hasSucceeded:!1});return e?e.lastSaveError:"NO_DATA_ERROR"},c.formatPlayerName=function(t){return!t||typeof t!="string"||typeof t=="string"&&t.length===0?"":t.trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s/g,"_").replace(/[^\w|-]/g,"").slice(0,30)};const $=function(t){return fetch(t,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>e.ok?!0:(o.error(`Error while fetching leaderboard view, server returned: ${e.status} ${e.statusText}`),!1),e=>(o.error("Error while fetching leaderboard view:",e),!1))},H=function(t,e,r){switch(typeof r.data=="string"?r.data:r.data.id){case"playerAuthenticated":i.playerAuthentication.login({runtimeScene:t,userId:r.data.userId,username:r.data.username,userToken:r.data.userToken});break;case"openPlayerAuthentication":i.playerAuthentication.openAuthenticationWindow(t,r.data.options).promise.then(({status:a})=>{if(!l||!l.contentWindow){o.warn("Unable to transmit the new login status to the leaderboard view.");return}if(a==="errored"){l.contentWindow.postMessage({id:"onPlayerAuthenticationErrored"},I);return}const g=i.playerAuthentication.getUserId(),s=i.playerAuthentication.getUserToken();if(a==="dismissed"||!g||!s){l.contentWindow.postMessage({id:"onPlayerAuthenticationDismissed"},I);return}l.contentWindow.postMessage({id:"onPlayerAuthenticated",playerId:g,playerUsername:i.playerAuthentication.getUsername(),playerToken:s},I)});break;case"closeLeaderboardView":D=!0,c.closeLeaderboardView(t);break;case"leaderboardViewLoaded":if(e&&(A&&clearTimeout(A),L(!1,t,{callOnErrorIfDomElementContainerMissing:!1})),!l){m(t,"The leaderboard view couldn't be found. Doing nothing.");return}l.style.opacity="1",f=!0,E=!1;break}},m=function(t,e){o.error(e),M=!0,E=!1,c.closeLeaderboardView(t)},U=t=>{A&&clearTimeout(A),A=setTimeout(()=>{f||m(t,"Leaderboard page did not send message in time. Closing leaderboard view.")},15e3)},L=function(t,e,r){const n=e.getGame().getRenderer().getDomElementContainer();if(!n)return r.callOnErrorIfDomElementContainerMissing&&m(e,"The div element covering the game couldn't be found, the leaderboard cannot be displayed."),!1;if(t)n.children&&n.children.length>0?n.insertBefore(h,n.children[0]):n.appendChild(h),l&&(l.style.opacity="0");else try{n.removeChild(h),l&&(l.style.opacity="1")}catch{}return!0},F=function(t){const e=document.createElement("iframe");return e.src=t,e.id="leaderboard-view",e.style.position="absolute",e.style.opacity="0",e.style.pointerEvents="all",e.style.backgroundColor="#FFFFFF",e.style.top="0px",e.style.height="100%",e.style.left="0px",e.style.width="100%",e.style.border="none",e};c.displayLeaderboard=async function(t,e,r){if(e===C){if(E){o.warn(`Already loading the view for the requested loader (${e}), ignoring.`);return}if(f){o.warn(`Already loaded the view for the requested loader (${e}), ignoring.`);return}}C=e,M=!1,f=!1,E=!0,r&&L(!0,t,{callOnErrorIfDomElementContainerMissing:!0});const n=u[e];n&&n.lastSavingPromise&&await n.lastSavingPromise;const a=n?n.lastSavedLeaderboardEntry:null,g=i.projectData.properties.projectUuid,s=t.getGame().isUsingGDevelopDevelopmentEnvironment(),d=new URLSearchParams;d.set("inGameEmbedded","true"),s&&d.set("dev","true"),a&&(d.set("playerLeaderboardEntryId",a.id),a.claimSecret&&d.set("playerLeaderboardEntryClaimSecret",a.claimSecret));const S=i.playerAuthentication.getUserId(),p=i.playerAuthentication.getUserToken();S&&p&&(d.set("playerId",S),d.set("playerToken",p),d.set("playerUsername",i.playerAuthentication.getUsername()));const w=`${I}/games/${g}/leaderboard/${e}?${d}`;try{const b=await $(w);if(e!==C){o.warn(`Received a response for leaderboard ${e} though the last leaderboard requested is ${C}, ignoring this response.`);return}if(!b){m(t,"Leaderboard data could not be fetched. Closing leaderboard view if there is one.");return}if(l)U(t),r&&L(!0,t,{callOnErrorIfDomElementContainerMissing:!1}),l.src=w;else{const v=t.getGame().getRenderer().getDomElementContainer();if(!v){m(t,"The div element covering the game couldn't be found, the leaderboard cannot be displayed.");return}U(t),l=F(w),typeof window!="undefined"&&(T=y=>{H(t,r,y)},window.addEventListener("message",T,!0)),v.appendChild(l)}}catch(b){o.error(b),m(t,"An error occurred when fetching leaderboard data. Closing leaderboard view if there is one.")}},c.isLeaderboardViewErrored=function(){return M},c.isLeaderboardViewLoaded=function(){return f},c.isLeaderboardViewLoading=function(){return E},c.closeLeaderboardView=function(t){try{if(L(!1,t,{callOnErrorIfDomElementContainerMissing:!1}),!l){o.info("The iframe displaying the current leaderboard couldn't be found, the leaderboard view must be already closed.");return}const e=t.getGame().getRenderer().getDomElementContainer();if(!e){o.info("The div element covering the game couldn't be found, the leaderboard view must be already closed.");return}typeof window!="undefined"&&(window.removeEventListener("message",T,!0),T=null),e.removeChild(l),l=null}finally{f=!1;const e=t.getGame().getRenderer().getCanvas();e&&e.focus()}}})(O=j.leaderboards||(j.leaderboards={}))})(G=i.evtTools||(i.evtTools={}))})(gdjs||(gdjs={}));
//# sourceMappingURL=leaderboardstools.js.map
